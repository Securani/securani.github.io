<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>web/TIC-TAC-TOE - Securani</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../intro.html">Securani's CTF writeups</a></li><li class="chapter-item expanded affix "><li class="spacer"></li><li class="chapter-item expanded "><div><strong aria-hidden="true">1.</strong> Pearl CTF 2025</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Pearl_CTF_2025/tictactoe.html" class="active"><strong aria-hidden="true">1.1.</strong> web/TIC-TAC-TOE</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.</strong> LA CTF 2025</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../LA_CTF_2025/purell.html"><strong aria-hidden="true">2.1.</strong> web/purell</a></li></ol></li><li class="chapter-item expanded "><li class="spacer"></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                    </div>

                    <h1 class="menu-title"><a style="text-decoration:none;" href="/">Securani</a></h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>


                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="webtic-tac-toe---pearl-ctf-2025"><a class="header" href="#webtic-tac-toe---pearl-ctf-2025">web/Tic-Tac-Toe - Pearl CTF 2025</a></h1>
<h4 id="category-web"><a class="header" href="#category-web"><strong>Category:</strong> Web</a></h4>
<p><strong>Description</strong>: This challenge involves interacting with a Tic-Tac-Toe game server through a Flask web application. The application acts as a proxy, forwarding requests to a Dockerized game API. The goal is to exploit vulnerabilities in the proxy and/or the Docker setup to read the flag located at <code>/flag/flag.txt</code> within the main container.</p>
<p><img src="imgs/tic-tac-toe/img1.png" alt="Image1" /></p>
<h2 id="understanding-the-code-and-application-flow"><a class="header" href="#understanding-the-code-and-application-flow">Understanding the Code and Application Flow</a></h2>
<p>The challenge consists of three main files: <code>app.py</code>, <code>url.py</code>, and <code>Dockerfile</code>. Let's break down how the application works:</p>
<p><strong>1. <code>app.py</code> (The Flask Application):</strong></p>
<pre><code class="language-python">from flask import Flask, render_template, request, jsonify
import requests, json
import url
import subprocess
import logging

app = Flask(__name__)
logging.basicConfig(level=logging.DEBUG)
logger = logging.getLogger(__name__)

def wrap_response(resp):
    try:
        parsed = json.loads(resp)
    except json.JSONDecodeError:
        parsed = resp

    return {&quot;body&quot;: parsed}

@app.route(&quot;/&quot;)
def home():
    return render_template(&quot;index.html&quot;)

@app.route(&quot;/deploy&quot;)
def deploy():
    container_inspect = subprocess.run([&quot;docker&quot;, &quot;inspect&quot;, &quot;game&quot;], stdout=subprocess.PIPE)
    resp = json.loads(container_inspect.stdout)
    
    if len(resp) &gt; 0:
        return jsonify({&quot;status&quot;: 1})
    
    docker_cmd = [&quot;docker&quot;, &quot;run&quot;, &quot;--rm&quot;, &quot;-d&quot;, &quot;-p&quot;, &quot;8000:8000&quot;, &quot;--name&quot;, &quot;game&quot;, &quot;b3gul4/tic-tac-toe&quot;]
    subprocess.run(docker_cmd)
    
    return jsonify({&quot;status&quot;: 0})

@app.route(&quot;/&quot;)
def game():
    return render_template(&quot;index.html&quot;)

@app.post(&quot;/&quot;)
def play():
    game = url.get_game_url(request.json)
    
    if game[&quot;error&quot;]:
        return jsonify({&quot;body&quot;: {&quot;error&quot;: game[&quot;error&quot;]}})
    
    try:
        if game[&quot;action&quot;] == &quot;post&quot;:
            resp = requests.post(game[&quot;url&quot;], json=request.json)
            if resp.status_code &lt; 200 or resp.status_code &gt;= 300:
                logger.debug(resp.text)
                return jsonify({&quot;body&quot;: {&quot;error&quot;: &quot;there was some error in game server&quot;}})
        else:
            resp = requests.get(game[&quot;url&quot;])
            if resp.status_code &lt; 200 or resp.status_code &gt;= 300:
                logger.debug(resp.text)
                return jsonify({&quot;body&quot;: {&quot;error&quot;: &quot;there was some error in game server&quot;}})
            
    except Exception as e:
        return jsonify({&quot;body&quot;: {&quot;error&quot;: &quot;game server down&quot;}})
        
    return jsonify(wrap_response(resp.text))

if __name__ == &quot;__main__&quot;:
    app.run(host=&quot;0.0.0.0&quot;, port=5000, debug=True)
</code></pre>
<ul>
<li><strong><code>@app.route(&quot;/&quot;)</code> (GET):</strong>  Renders the main <code>index.html</code> page, which contains the Tic-Tac-Toe board and buttons for interacting with the game.</li>
<li><strong><code>@app.route(&quot;/deploy&quot;)</code> (GET):</strong>  Deploys the Tic-Tac-Toe game server (a separate Docker container) if it's not already running.  It uses <code>docker run</code> to start the <code>b3gul4/tic-tac-toe</code> image.</li>
<li><strong><code>@app.post(&quot;/&quot;)</code> (POST) - The <code>play</code> function:</strong> This is the most important part for the exploit.  It's designed to proxy requests to the game server. Here's how it works:
<ol>
<li>It receives a JSON payload from the client (the web browser).</li>
<li>It calls <code>url.get_game_url(request.json)</code> to construct the URL for the game server.</li>
<li>Based on the <code>action</code> field in the JSON (either &quot;get&quot; or &quot;post&quot;), it makes a corresponding <code>GET</code> or <code>POST</code> request to the constructed URL using the <code>requests</code> library.</li>
<li>It returns the response from the game server (or an error message) to the client.</li>
</ol>
</li>
</ul>
<p><strong>2. <code>url.py</code> (URL Construction):</strong></p>
<pre><code class="language-python">import os

URL = &quot;http://&lt;domain&gt;:&lt;port&gt;/&lt;game_action&gt;&quot;

def is_valid_state(state):
    if len(state) != 9:
        return False
    
    for s in state:
        if s not in [&quot;X&quot;, &quot;O&quot;, &quot;_&quot;]:
            return False
    
    return True

def get_game_url(req_json):
    try:
        api = req_json[&quot;api&quot;]
        keys = list(api.keys())
        
        url = URL.replace(&quot;&lt;domain&gt;&quot;, os.getenv(&quot;GAME_API_DOMAIN&quot;))
        url = url.replace(&quot;&lt;port&gt;&quot;, os.getenv(&quot;GAME_API_PORT&quot;))
        # The game api is going to have many more endpoints in future, I do not want to hardcode the action
        url = url.replace(keys[0], api[keys[0]])
        
        if not is_valid_state(req_json[&quot;state&quot;]):
            return {&quot;url&quot;: None, &quot;action&quot;: None, &quot;error&quot;: &quot;Invalid state&quot;}
        
        return {&quot;url&quot;: url, &quot;action&quot;: req_json[&quot;action&quot;], &quot;error&quot;: None}
    
    except Exception as e:
        print(e)
        return {&quot;url&quot;: None, &quot;action&quot;: None, &quot;error&quot;: &quot;Internal server error&quot;}
</code></pre>
<ul>
<li><strong><code>URL = &quot;http://&lt;domain&gt;:&lt;port&gt;/&lt;game_action&gt;&quot;</code>:</strong> This is a template URL.  The placeholders (<code>&lt;domain&gt;</code>, <code>&lt;port&gt;</code>, <code>&lt;game_action&gt;</code>) are meant to be replaced with actual values.</li>
<li><strong><code>get_game_url(req_json)</code>:</strong> This function is the <em>source</em> of the SSRF vulnerability.  It takes the JSON payload from the <code>app.post(&quot;/&quot;)</code> request and does the following:
<ol>
<li>It extracts the <code>api</code> field from the JSON.  The <code>api</code> field is expected to be a dictionary.</li>
<li>It gets the <em>first key</em> from the <code>api</code> dictionary (<code>keys[0]</code>).  This key is assumed to be a string containing placeholders that should be present in the <code>URL</code> template.</li>
<li>It replaces the <em>entire first key</em> with the <em>corresponding value</em> from the <code>api</code> dictionary (<code>api[keys[0]]</code>).</li>
<li>It replaces <code>&lt;domain&gt;</code> and <code>&lt;port&gt;</code> with environment variables.</li>
<li>it checks state, but it is not a vulnerability.</li>
</ol>
</li>
</ul>
<p><strong>The SSRF Vulnerability in <code>url.py</code>:</strong></p>
<p>The vulnerability lies in this line:</p>
<pre><code class="language-python">url = url.replace(keys[0], api[keys[0]])
</code></pre>
<p>The code takes the <em>value</em> associated with the first key in the <code>api</code> dictionary (<code>api[keys[0]]</code>) and uses it <em>directly</em> in the <code>url.replace()</code> call, <em>without any validation or sanitization</em>.  This means an attacker can provide <em>any arbitrary string</em> as the value, and that string will be used to construct the final URL.  Since the Flask application then makes a request to this constructed URL, the attacker can control the destination of the request â€“ this is Server-Side Request Forgery (SSRF).</p>
<p><strong>3. <code>Dockerfile</code> (Container Build Instructions):</strong></p>
<pre><code class="language-dockerfile">FROM python:3.9-alpine

RUN apk add --no-cache docker-cli

WORKDIR /app

COPY requirements.txt .

RUN pip install -r requirements.txt

COPY ./templates ./templates
COPY app.py .
COPY url.py .
COPY flag.txt /flag/

ENV DOCKER_HOST=&quot;tcp://localhost:2375&quot;
ENV GAME_API_DOMAIN=&quot;localhost&quot;
ENV GAME_API_PORT=&quot;8000&quot;

CMD [&quot;gunicorn&quot;, &quot;--bind&quot;, &quot;0.0.0.0:80&quot;, &quot;app:app&quot;, &quot;--capture-output&quot;, &quot;--log-level&quot;, &quot;debug&quot;]
</code></pre>
<ul>
<li><strong><code>FROM python:3.9-alpine</code>:</strong>  Uses a lightweight Python 3.9 image as the base.</li>
<li><strong><code>RUN apk add --no-cache docker-cli</code>:</strong>  This is the <strong>critical line</strong> that introduces the second major vulnerability.  It installs the Docker CLI <em>inside</em> the application container. This means the container running the Flask application has the ability to interact with the Docker daemon.</li>
<li><strong><code>WORKDIR /app</code>:</strong> Sets the working directory inside the container.</li>
<li><strong><code>COPY requirements.txt .</code>  and  <code>RUN pip install -r requirements.txt</code>:</strong>  Installs the Python dependencies (Flask, requests, gunicorn, etc.).</li>
<li><strong><code>COPY ./templates ./templates</code>, <code>COPY app.py .</code>, <code>COPY url.py .</code>:</strong> Copies the application code and templates into the container.</li>
<li><strong><code>COPY flag.txt /flag/</code>:</strong>  This is very important!  It copies the <code>flag.txt</code> file into the <code>/flag/</code> directory <em>within the application container</em>.  This means the flag is accessible <em>inside</em> the container that runs <code>app.py</code>, <em>not</em> inside the separate game container.</li>
<li><strong><code>ENV DOCKER_HOST=&quot;tcp://localhost:2375&quot;</code>:</strong> This environment variable tells the Docker CLI (which we installed earlier) how to connect to the Docker daemon.  <code>tcp://localhost:2375</code> means it will connect to the Docker daemon on the host machine (where the container is running) over TCP port 2375.  This is a common (but insecure) way to expose the Docker socket.</li>
<li><strong><code>ENV GAME_API_DOMAIN=&quot;localhost&quot;</code>, <code>ENV GAME_API_PORT=&quot;8000&quot;</code>:</strong> These environment variables are used by <code>url.py</code> to construct the URL for the game API (although we'll be abusing this).</li>
<li><strong><code>CMD [&quot;gunicorn&quot;, &quot;--bind&quot;, &quot;0.0.0.0:80&quot;, &quot;app:app&quot;, &quot;--capture-output&quot;, &quot;--log-level&quot;, &quot;debug&quot;]</code>:</strong> This is the command that runs when the container starts. It uses <code>gunicorn</code> (a production-ready WSGI server) to run the Flask application (<code>app.py</code>).</li>
</ul>
<p>The <code>Dockerfile</code> clearly shows that the application container has:</p>
<ol>
<li>The Docker CLI installed.</li>
<li>The <code>DOCKER_HOST</code> environment variable set to connect to the host's Docker daemon.</li>
<li>The flag file located at <code>/flag/flag.txt</code>.</li>
</ol>
<p>These three facts are essential for the exploit.</p>
<h2 id="vulnerabilities-ssrf-and-docker-socket-access"><a class="header" href="#vulnerabilities-ssrf-and-docker-socket-access">Vulnerabilities: SSRF and Docker Socket Access</a></h2>
<p>This challenge presents two critical vulnerabilities:</p>
<ol>
<li>
<p><strong>Server-Side Request Forgery (SSRF) in <code>app.py</code> and <code>url.py</code>:</strong> As explained above, the lack of input validation in <code>url.get_game_url</code> allows an attacker to control the URL to which the Flask application makes requests.</p>
</li>
<li>
<p><strong>Docker Socket Access:</strong> The Flask application container has access to the Docker socket (<code>tcp://localhost:2375</code>). This, combined with the SSRF, allows us to control the Docker daemon.</p>
</li>
</ol>
<h2 id="exploitation"><a class="header" href="#exploitation">Exploitation</a></h2>
<p>The key to solving this challenge is to combine the SSRF vulnerability with the Docker socket access. We'll use the SSRF to make requests to the Docker API, ultimately reading the flag.</p>
<p>Here's the refined exploitation strategy:</p>
<ol>
<li><strong>Reconnaissance with <code>/containers/json</code> (SSRF Confirmation):</strong></li>
<li><strong>Create a Container to Mount the Flag:</strong></li>
<li><strong>Retrieve the Flag:</strong></li>
</ol>
<p>Here are the steps and payloads in detail:</p>
<p><strong>Step 1: SSRF Reconnaissance with <code>/containers/json</code></strong></p>
<p>This step is crucial for confirming our ability to reach the Docker API through the SSRF.</p>
<p><strong>Example of Request and Response sent when clicking &quot;Ping!&quot; button on website:</strong>
<img src="imgs/tic-tac-toe/img2.png" alt="Image2" />
<img src="imgs/tic-tac-toe/img2_2.png" alt="Image2_2" /></p>
<p><strong>Testing SSRF vulnerability</strong>
<img src="imgs/tic-tac-toe/img3.png" alt="Image3" /></p>
<ul>
<li><strong><code>&quot;localhost:8000/&lt;game_action&gt;&quot;: &quot;127.0.0.1:2375/containers/json&quot;</code>:</strong> This is where we exploit the SSRF. The key is replaced with Docker API endpoint.</li>
</ul>
<p><img src="imgs/tic-tac-toe/img3_2.png" alt="Image3_2" /></p>
<p>If the response contains a JSON array describing running Docker containers, we have successfully confirmed the SSRF.</p>
<p><strong>Step 2: Create a Container to Mount the Flag</strong></p>
<p><strong>Request and Response:</strong>
<img src="imgs/tic-tac-toe/img4.png" alt="Image4" />
<img src="imgs/tic-tac-toe/img4_2.png" alt="Image4_2" /></p>
<p><strong>Step 3: Retrieve the Flag</strong>
We use <code>/containers/{id}/archive</code> and send id of our container (we get it in the previous step).</p>
<p><strong>Request and Response:</strong>
<img src="imgs/tic-tac-toe/img5.png" alt="Image5" />
<img src="imgs/tic-tac-toe/img5_2.png" alt="Image5_2" /></p>
<p>The response contains the flag.</p>
<pre><code>pearl{do_y0u_r34llY_kn0w_d0ck3r_w3ll?}
</code></pre>
<h2 id="conclusion"><a class="header" href="#conclusion">Conclusion</a></h2>
<p>If you enjoyed this write-up and found it useful, feel free to <strong>add me on <a href="https://linkedin.com/in/morzelowski">LinkedIn</a></strong> for more CTF challenges, security research, and infosec content!</p>
<p>Also, be sure to check out <strong><a href="https://www.linkedin.com/company/securani/">Securani Linkedin</a></strong> for more cybersecurity insights, challenges, and learning resources. ðŸš€ðŸ”’</p>
<p>Stay curious and keep hacking! ðŸ˜ˆðŸ”¥</p>
<p>M0U</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../intro.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../LA_CTF_2025/purell.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../intro.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../LA_CTF_2025/purell.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>



        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
